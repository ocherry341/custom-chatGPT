<!-- Header -->
<div class="chat-header">
  <div class="header-fixed">
    <div class="title">
      <d-icon icon="icon-list-view" [color]="'white'" title="读取对话"
        (click)="showList('CHAT_SESSION')" style="margin-right: 8px;"></d-icon>

      <div class="title-text" #titleDiv (click)="changeTitle(titleInput,titleDiv)">
        {{chatTitle}}</div>
      <input dTextInput class="hide" #titleInput
        (blur)="changeTitleSubmit(titleInput,titleDiv)" [value]="chatTitle">

    </div>
    <d-icon-group>
      <span style="margin-right: 18px;">
        <span style="font-size: 14px;margin-right: 5px;">stream</span>
        <d-toggle [(ngModel)]="stream"></d-toggle>
      </span>
      <d-icon icon="icon-go-module" [color]="'white'" title="切换配置"
        (click)="showList('CHAT_OPTIONS')"></d-icon>
      <d-icon icon="icon-setting" [color]="'white'" title="设置"
        [routerLink]="'./setting'"></d-icon>
    </d-icon-group>
  </div>
</div>

<div class="chat-content">
  <!-- List -->
  <div class="chat-list" (mouseleave)="mouseout()">
    <ng-container *ngFor="let msg of messages;index as i">
      <!-- User Block -->
      <div class="chat-item" *ngIf="msg.role==='user'">
        <div>{{msg.content}}</div>
      </div>
      <!-- Bot Block -->
      <div class="chat-item bot" (mouseover)="chatListHover(i)"
        *ngIf="msg.role==='assistant'">
        <markdown clipboard [data]="msg.content"></markdown>
        <div *ngIf="i===hoverIndex && i!==savedIndex " class="save">
          <d-icon title="保存对话" icon="icon-save" [operable]="true"
            (click)="saveChats(i)">
          </d-icon>
        </div>
        <div *ngIf="i===savedIndex" class="save">
          <d-icon title="已保存" icon="icon-save" [operable]="true" [color]="'#5e7ce0'">
          </d-icon>
        </div>
      </div>
    </ng-container>
    <!-- Loading Block -->
    <div *ngIf="genStart" class="chat-item bot loading">
      <d-icon [icon]="'icon-loading'" [rotate]="'infinite'">
        <span iconSuffix>加载中</span>
      </d-icon>
    </div>
    <!-- Error Block -->
    <div *ngIf="haveError" class="chat-item bot error">
      <d-icon [icon]="'icon-error-o'" [color]="'rgb(249, 95, 91)'"></d-icon>
      <div>{{errMessage}}</div>
    </div>
  </div>

  <!-- Footer -->
  <div class="chat-footer">
    <div class="footer-bar">
      <d-button class="large-btn" bsSize='lg' (btnClick)="clear()" icon="icon-delete"
        bsStyle="primary" title="重置"></d-button>
      <textarea #textarea class="chat-textarea" name="chat" [(ngModel)]="chatInput"
        dTextarea (input)="setTextareaHeight()" (keydown)="preventEnter($event)"
        (keyup)="enter($event)" [disabled]="!haveApiKey"></textarea>
      <d-button class="large-btn main" (btnClick)="startChat()"
        [icon]="genPendding?'icon-loading devui-icon-spin':'icon-publish'" title="发送"
        [disabled]="!haveApiKey"></d-button>
    </div>
  </div>
  <div #placeholder class="footer-placeholder"></div>

</div>

<div class="login" *ngIf="!haveApiKey">
  <div class="input-bar">
    <input dTextInput #keyInput placeholder="输入ApiKey" type="password">
    <a dTooltip [content]="'获取ApiKey'" target="_blank" class="model-help"
      href="https://platform.openai.com/account/api-keys/">
      <i class="icon icon-helping"></i></a>
  </div>
  <d-button bsSize="lg" [bordered]="true"
    (btnClick)="setApiKey(keyInput.value)">确定</d-button>
</div>

<d-button *ngIf="genPendding" class="gen-controller" [bordered]="true" bsSize='lg'
  icon="icon-stop" title="停止" (btnClick)="stop()">停止</d-button>

<d-button *ngIf="!genPendding && messages.length!==0" class="gen-controller"
  bsSize='lg' [bordered]="true" icon="icon-refresh"
  (btnClick)="reGenerate()">重新生成</d-button>